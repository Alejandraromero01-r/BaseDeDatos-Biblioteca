-- Vista de libros disponibles para prÃ©stamo
CREATE OR REPLACE VIEW vista_libros_disponibles AS
SELECT l.libro_id, l.titulo, STRING_AGG(DISTINCT a.nombre, ', ') AS autores,
       COUNT(e.ejemplar_id) FILTER (WHERE e.estado='disponible') AS ejemplares_disponibles
FROM Libros l
JOIN Libros_Autores la ON la.libro_id = l.libro_id
JOIN Autores a ON a.autor_id = la.autor_id
JOIN Ejemplares e ON e.libro_id = l.libro_id
GROUP BY l.libro_id, l.titulo
HAVING COUNT(e.ejemplar_id) FILTER (WHERE e.estado='disponible') > 0;
